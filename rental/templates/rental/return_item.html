{% extends "base.html" %}
{% load form_helpers static %}

{% block content %}
<div class="container my-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-truck-loading me-2"></i>
                Process Rental Return #{{ rental.id }}
            </h5>
            <span class="badge bg-light text-dark">
                {{ rental.get_status_display }}
            </span>
        </div>
        
        <div class="card-body">
            <!-- Rental Summary -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <h5><i class="fas fa-user me-2"></i>Customer Details</h5>
                    <p><strong>Name:</strong> {{ rental.customer.name }}</p>
                    <p><strong>Company:</strong> {{ rental.customer.company|default:"-" }}</p>
                    <p><strong>Start Date:</strong> {{ rental.start_date }}</p>
                </div>
                <div class="col-md-6">
                    <h5><i class="fas fa-calendar-alt me-2"></i>Rental Dates</h5>
                    <p><strong>Expected Return:</strong> {{ rental.expected_return_date }}</p>
                    <p><strong>Today:</strong> {{ today }}</p>
                    <p class="{% if overdue_days > 0 %}text-danger{% endif %}">
                        <strong>Overdue Days:</strong> {{ overdue_days }}
                    </p>
                </div>
            </div>

            <!-- Rental Calculation -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">Rental Calculation</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <td>Original Rental Period:</td>
                                    <td>{{ rental.start_date }} to {{ rental.expected_return_date }} ({{ rental.rental_days }} days)</td>
                                </tr>
                                <tr>
                                    <td>Actual Rental Period:</td>
                                    <td>{{ rental.start_date }} to <span id="actualReturnDate">{{ today }}</span> (<span id="actualRentalDays">{{ rental_days }}</span> days)</td>
                                </tr>
                                <tr>
                                    <td>Daily Rate:</td>
                                    <td>${{ daily_rate|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td>Base Rental Amount:</td>
                                    <td>$ <span id="baseRentalAmount">{{ base_amount|floatformat:2 }}</span></td>
                                </tr>
                                {% if rental.discount > 0 %}
                                <tr>
                                    <td>Discount ({{ rental.discount }}%):</td>
                                    <td>-$ <span id="discountAmount">{{ discount_amount|floatformat:2 }}</span></td>
                                </tr>
                                {% endif %}
                                {% if rental.apply_vat %}
                                <tr>
                                    <td>VAT (5%):</td>
                                    <td>$ <span id="vatAmount">{{ vat_amount|floatformat:2 }}</span></td>
                                </tr>
                                {% endif %}
                                <tr class="table-active">
                                    <th>Actual Total:</th>
                                    <th>$ <span id="actualTotal">{{ actual_total|floatformat:2 }}</span></th>
                                </tr>
                                <tr>
                                    <td>Advance Payment:</td>
                                    <td>-${{ rental.advance_payment|floatformat:2 }}</td>
                                </tr>
                                <tr class="table-warning">
                                    <th>Balance Due:</th>
                                    <th>$ <span id="finalBalanceDue">{{ balance_due|floatformat:2 }}</span></th>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <hr>
            
            <!-- Items to Return -->
            <h5 class="mb-3"><i class="fas fa-boxes me-2"></i>Items to Return</h5>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Return Condition</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in rental.items.all %}
                        <tr>
                            <td>{{ item.product.name }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>
                                {{ form|get_item_condition_field:item.id }}
                            </td>
                            <td>
                                {{ form|get_item_notes_field:item.id }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <hr>
            
            <!-- Return Form -->
            <form method="post" id="returnForm">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-6">
                        <!-- Return Date -->
                        <div class="mb-3">
                            <label class="form-label">{{ form.return_date.label }}</label>
                            {{ form.return_date }}
                        </div>
                        
                        <!-- Payment Details -->
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Payment Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">{{ form.amount_to_collect.label }}</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.amount_to_collect }}
                                    </div>
                                    <small class="text-muted">Balance Due: <span id="balanceDue">{{ balance_due|floatformat:2 }}</span></small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">{{ form.payment_method.label }}</label>
                                    {{ form.payment_method }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <!-- Notes -->
                        <div class="mb-3">
                            <label class="form-label">{{ form.notes.label }}</label>
                            {{ form.notes }}
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'rental_detail' rental.id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times-circle me-2"></i> Cancel
                    </a>
                    <button type="button" id="confirmReturnBtn" class="btn btn-success">
                        <i class="fas fa-check-circle me-2"></i> Complete Return
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="confirmationModalLabel">Confirm Rental Return</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to process this rental return?</p>
                <div class="alert alert-info">
                    <strong>Details:</strong>
                    <ul class="mb-0">
                        <li>Customer: {{ rental.customer.name }}</li>
                        <li>Rental Period: {{ rental.start_date }} to <span id="modalReturnDate">{{ today }}</span></li>
                        <li>Total Days: <span id="modalRentalDays">{{ rental_days }}</span></li>
                        <li>Amount to Collect: $ <span id="modalAmountToCollect">{{ balance_due|floatformat:2 }}</span></li>
                    </ul>
                </div>
                <p class="mb-0">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmSubmitBtn" class="btn btn-success">Confirm Return</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/moment.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all required elements
    const returnDateInput = document.getElementById('id_return_date');
    const amountInput = document.getElementById('id_amount_to_collect');
    const actualReturnDateSpan = document.getElementById('actualReturnDate');
    const actualRentalDaysSpan = document.getElementById('actualRentalDays');
    const baseRentalAmountSpan = document.getElementById('baseRentalAmount');
    const discountAmountSpan = document.getElementById('discountAmount');
    const vatAmountSpan = document.getElementById('vatAmount');
    const actualTotalSpan = document.getElementById('actualTotal');
    const balanceDueSpan = document.getElementById('balanceDue');
    const finalBalanceDueSpan = document.getElementById('finalBalanceDue');
    const modalReturnDateSpan = document.getElementById('modalReturnDate');
    const modalRentalDaysSpan = document.getElementById('modalRentalDays');
    const modalAmountToCollectSpan = document.getElementById('modalAmountToCollect');
    const confirmReturnBtn = document.getElementById('confirmReturnBtn');
    const confirmSubmitBtn = document.getElementById('confirmSubmitBtn');
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const returnForm = document.getElementById('returnForm');

    // Constants from template
    const dailyRate = {{ daily_rate }};
    const advancePayment = {{ rental.advance_payment }};
    const discountRate = {{ rental.discount }};
    const applyVat = {% if rental.apply_vat %}true{% else %}false{% endif %};
    const startDate = new Date('{{ rental.start_date|date:"Y-m-d" }}');
    const originalRentalDays = {{ rental.rental_days }};
    const originalSubtotal = {{ rental.subtotal }};

    // Update amount field when return date changes
    if (returnDateInput && amountInput) {
        returnDateInput.addEventListener('change', function() {
            const returnDate = new Date(this.value);
            
            // Calculate days difference (+1 to include both dates)
            const timeDiff = returnDate - startDate;
            const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1;
            
            // Calculate new amounts based on original daily rates
            const baseAmount = (originalSubtotal / originalRentalDays) * daysDiff;
            const discountAmount = baseAmount * (discountRate / 100);
            const subtotal = baseAmount - discountAmount;
            const vatAmount = applyVat ? subtotal * 0.05 : 0;
            const total = subtotal + vatAmount;
            const balanceDue = Math.max(0, total - advancePayment);
            
            // Update display
            actualReturnDateSpan.textContent = this.value;
            actualRentalDaysSpan.textContent = daysDiff;
            baseRentalAmountSpan.textContent = baseAmount.toFixed(2);
            
            if (discountRate > 0) {
                discountAmountSpan.textContent = discountAmount.toFixed(2);
            }
            
            if (applyVat) {
                vatAmountSpan.textContent = vatAmount.toFixed(2);
            }
            
            actualTotalSpan.textContent = total.toFixed(2);
            balanceDueSpan.textContent = balanceDue.toFixed(2);
            finalBalanceDueSpan.textContent = balanceDue.toFixed(2);
            
            // Update amount to collect
            amountInput.value = balanceDue.toFixed(2);
        });
    }

    // Show confirmation modal when return button is clicked
    confirmReturnBtn.addEventListener('click', function() {
        // Update modal with current values
        modalReturnDateSpan.textContent = returnDateInput.value || '{{ today }}';
        modalRentalDaysSpan.textContent = actualRentalDaysSpan.textContent;
        modalAmountToCollectSpan.textContent = amountInput.value || balanceDueSpan.textContent;
        
        // Show modal
        confirmationModal.show();
    });

    // Submit form when confirmed in modal
    confirmSubmitBtn.addEventListener('click', function() {
        returnForm.submit();
        confirmationModal.hide();
    });
});
</script>
{% endblock %}